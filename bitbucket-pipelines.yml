image: golang
definitions:
  services:
    docker: # can only be used with a self-hosted runner
      image: docker:dind

pipelines:
  default:
    - step:
        name: Testing
        script:
          - echo "test"
          - echo $BITBUCKET_BRANCH
          - echo $BITBUCKET_TAG
  tags:
    - step:
        name: Testing
        script:
          - echo "test"
          - echo $BITBUCKET_BRANCH
          - echo $BITBUCKET_TAG
  custom:
    build-and-push:
      - step:
          name: Build
          image: valkyrie00/buildx:latest
          runs-on:
            - self.hosted
            - valkyrie
          services:
            - docker
          script:
            - mkdir -p /go/src/bitbucket.org/no-name-game
            - cp -R $(pwd) /go/src/bitbucket.org/no-name-game/nn-telegram
            - git clone -b develop git@bitbucket.org:no-name-game/nn-grpc.git /go/src/bitbucket.org/no-name-game/nn-telegram/nn-grpc
            - cd /go/src/bitbucket.org/no-name-game/nn-telegram
            - docker login -u $DOCKER_HUB_USER -p $DOCKER_HUB_PASSWORD
            - docker run --rm --privileged multiarch/qemu-user-static --reset -p yes; docker buildx create --use
            - docker buildx build --push --platform linux/arm64 -t valkyrie00/nn-telegram:testing -f deployment/docker/Dockerfile .